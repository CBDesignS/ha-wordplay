<!-- Rev 2.0 - Added complete i18n support with data-i18n attributes for Current languages -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPlay Detailed Statistics</title>
    <style>
        /* CSS Variables from wordplay_game.html */
        :root {
            --primary-color: #03a9f4;
            --accent-color: #ff9800;
            
            --tile-correct: #4caf50;
            --tile-partial: #ff9800;
            --tile-absent: #9e9e9e;
            --tile-empty: #ffffff;
            --tile-border: #d1d5db;
            
            --card-margin: 16px;
            --tile-gap: 4px;
            --tile-size: 60px;
        }

        /* Light theme (default) */
        :root {
            --primary-background-color: #fafafa;
            --secondary-background-color: #e5e5e5;
            --text-primary-color: #212121;
            --text-secondary-color: #727272;
            --divider-color: #e0e0e0;
        }

        /* Dark theme auto-detection */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-background-color: #111111;
                --secondary-background-color: #1e1e1e;
                --text-primary-color: #ffffff;
                --text-secondary-color: #b3b3b3;
                --divider-color: #333333;
                --tile-empty: #2c2c2c;
                --tile-border: #444444;
            }
        }

        /* HA theme integration */
        body[data-theme="dark"] {
            --primary-background-color: #111111;
            --secondary-background-color: #1e1e1e;
            --text-primary-color: #ffffff;
            --text-secondary-color: #b3b3b3;
            --divider-color: #333333;
            --tile-empty: #2c2c2c;
            --tile-border: #444444;
        }

        body[data-theme="light"] {
            --primary-background-color: #fafafa;
            --secondary-background-color: #e5e5e5;
            --text-primary-color: #212121;
            --text-secondary-color: #727272;
            --divider-color: #e0e0e0;
            --tile-empty: #ffffff;
            --tile-border: #d1d5db;
        }

        * { box-sizing: border-box; }

        body {
            font-family: Roboto, sans-serif;
            background: var(--primary-background-color);
            margin: 0;
            padding: 20px;
            color: var(--text-primary-color);
        }

        .stats-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--secondary-background-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .stats-header {
            background: var(--primary-color);
            color: white;
            padding: 16px;
            text-align: center;
        }

        .stats-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 8px 0;
        }

        .stats-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }

        .stats-content {
            padding: 24px;
        }

        .stats-section {
            background: var(--primary-background-color);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--divider-color);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary-color);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Overview Stats Grid */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--tile-empty);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--divider-color);
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary-color);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Guess Distribution Chart */
        .distribution-chart {
            margin: 20px 0;
        }

        .chart-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .guess-number {
            font-weight: bold;
            width: 20px;
            text-align: center;
            color: var(--text-primary-color);
        }

        .chart-bar {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-count {
            margin-left: auto;
            color: var(--text-secondary-color);
            font-weight: bold;
            min-width: 20px;
        }

        /* Difficulty Stats */
        .difficulty-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .difficulty-card {
            background: var(--tile-empty);
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--divider-color);
            text-align: center;
        }

        .difficulty-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .difficulty-name {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary-color);
            margin-bottom: 8px;
        }

        .difficulty-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            text-align: center;
        }

        .difficulty-stat {
            background: var(--primary-background-color);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--divider-color);
        }

        .difficulty-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }

        .difficulty-stat-label {
            font-size: 10px;
            color: var(--text-secondary-color);
            text-transform: uppercase;
        }

        /* Time Stats */
        .time-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        /* Achievements */
        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .achievement {
            background: var(--tile-empty);
            border: 2px solid var(--divider-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            min-width: 140px;
            max-width: 180px;
            transition: all 0.3s ease;
        }

        .achievement.earned {
            border-color: var(--tile-correct);
            background: rgba(76, 175, 80, 0.1);
        }

        .achievement.locked {
            opacity: 0.6;
            border-color: var(--tile-absent);
        }

        .achievement-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .achievement-name {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary-color);
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 10px;
            color: var(--text-secondary-color);
            line-height: 1.2;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .action-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .action-btn.primary:hover,
        .action-btn.primary:focus {
            background: #0288d1;
            transform: scale(1.05);
        }

        .action-btn.secondary {
            background: var(--tile-absent);
            color: white;
        }

        .action-btn.secondary:hover,
        .action-btn.secondary:focus {
            transform: scale(1.05);
        }

        /* Loading animation */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary-color);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--divider-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px auto;
        }

        /* Status message */
        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            max-width: 400px;
            text-align: center;
        }

        .status-message.show {
            opacity: 1;
        }

        .status-message.success {
            background: var(--tile-correct);
        }

        .status-message.error {
            background: #f44336;
        }

        /* Close button */
        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-btn:hover,
        .close-btn:focus {
            background: rgba(255,255,255,0.3);
            outline: none;
        }

        /* Accessibility helper descriptions */
        .helper-descriptions {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }

        .helper-descriptions span {
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .stats-content { padding: 16px; }
            .stats-section { padding: 16px; }
            .overview-grid { grid-template-columns: repeat(2, 1fr); }
            .action-buttons { flex-direction: column; }
        }

        @media (max-width: 480px) {
            .stats-container { margin: 5px; border-radius: 4px; }
            .overview-grid { grid-template-columns: 1fr; }
            .difficulty-stats { grid-template-columns: 1fr; }
            .time-stats { grid-template-columns: 1fr; }
            .achievements { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="stats-container" role="main">
        <div class="stats-header">
            <button class="close-btn" onclick="closeStats()" aria-label="Close statistics window" title="Close">√ó</button>
            <h1 class="stats-title" data-i18n="stats.title">üìä Detailed Statistics</h1>
            <p class="stats-subtitle" id="userNameDisplay" data-i18n="stats.loading">Loading your game statistics...</p>
        </div>

        <div class="stats-content" id="statsContent">
            <div class="loading" id="loadingIndicator" role="status" aria-live="polite">
                <div class="loading-spinner" aria-hidden="true"></div>
                <span data-i18n="stats.loading">Loading your game statistics...</span>
            </div>

            <!-- Overview Section -->
            <div class="stats-section" id="overviewSection" style="display: none;">
                <h2 class="section-title" data-i18n="stats.overview">üèÜ Game Overview</h2>
                <div class="overview-grid" role="region" aria-labelledby="overview-title">
                    <h3 id="overview-title" class="sr-only" data-i18n="stats.overview">Game Statistics Overview</h3>
                    <div class="stat-card">
                        <span class="stat-value" id="totalGames" aria-label="Total games played">0</span>
                        <span class="stat-label" data-i18n="stats.totalGames">Total Games</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="totalWins" aria-label="Total games won">0</span>
                        <span class="stat-label" data-i18n="stats.gamesWon">Games Won</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="winPercentage" aria-label="Win percentage">0%</span>
                        <span class="stat-label" data-i18n="stats.winRate">Win Rate</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="currentStreak" aria-label="Current winning streak">0</span>
                        <span class="stat-label" data-i18n="stats.currentStreak">Current Streak</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="maxStreak" aria-label="Best winning streak">0</span>
                        <span class="stat-label" data-i18n="stats.bestStreak">Best Streak</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="averageGuesses" aria-label="Average guesses per win">0.0</span>
                        <span class="stat-label" data-i18n="stats.avgGuesses">Avg Guesses</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="totalPlayTime" aria-label="Total time played">0s</span>
                        <span class="stat-label" data-i18n="stats.totalPlayTime">Total Play Time</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="fastestWin" aria-label="Fastest win time">N/A</span>
                        <span class="stat-label" data-i18n="stats.fastestWin">Fastest Win</span>
                    </div>
                </div>
            </div>

            <!-- Guess Distribution Section -->
            <div class="stats-section" id="distributionSection" style="display: none;">
                <h2 class="section-title" data-i18n="stats.distribution">üìà Guess Distribution</h2>
                <div class="distribution-chart" id="guessChart" role="img" aria-labelledby="chart-title" aria-describedby="chart-desc">
                    <h3 id="chart-title" class="sr-only" data-i18n="stats.distribution">Guess Distribution Chart</h3>
                    <p id="chart-desc" class="sr-only">Bar chart showing how many games were won in each number of guesses</p>
                    <!-- Chart will be populated by JavaScript -->
                </div>
            </div>

            <!-- Difficulty Stats Section -->
            <div class="stats-section" id="difficultySection" style="display: none;">
                <h2 class="section-title" data-i18n="stats.difficulty">üéØ Performance by Difficulty</h2>
                <div class="difficulty-stats" role="region" aria-labelledby="difficulty-title">
                    <h3 id="difficulty-title" class="sr-only" data-i18n="stats.difficulty">Performance by Difficulty</h3>
                    
                    <div class="difficulty-card" id="easyCard">
                        <div class="difficulty-icon">üü¢</div>
                        <div class="difficulty-name" data-i18n="stats.easyMode">Easy Mode</div>
                        <div class="difficulty-stats-grid">
                            <div class="difficulty-stat">
                                <span class="difficulty-stat-value" id="easyWins">0</span>
                                <span class="difficulty-stat-label" data-i18n="stats.gamesWon">Won</span>
                            </div>
                            <div class="difficulty-stat">
                                <span class="difficulty-stat-value" id="easyRate">0%</span>
                                <span class="difficulty-stat-label" data-i18n="stats.winRate">Rate</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="difficulty-card" id="normalCard">
                        <div class="difficulty-icon">üü°</div>
                        <div class="difficulty-name" data-i18n="stats.normalMode">Normal Mode</div>
                        <div class="difficulty-stats-grid">
                            <div class="difficulty-stat">
                                <span class="difficulty-stat-value" id="normalWins">0</span>
                                <span class="difficulty-stat-label" data-i18n="stats.gamesWon">Won</span>
                            </div>
                            <div class="difficulty-stat">
                                <span class="difficulty-stat-value" id="normalRate">0%</span>
                                <span class="difficulty-stat-label" data-i18n="stats.winRate">Rate</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="difficulty-card" id="hardCard">
                        <div class="difficulty-icon">üî¥</div>
                        <div class="difficulty-name" data-i18n="stats.hardMode">Hard Mode</div>
                        <div class="difficulty-stats-grid">
                            <div class="difficulty-stat">
                                <span class="difficulty-stat-value" id="hardWins">0</span>
                                <span class="difficulty-stat-label" data-i18n="stats.gamesWon">Won</span>
                            </div>
                            <div class="difficulty-stat">
                                <span class="difficulty-stat-value" id="hardRate">0%</span>
                                <span class="difficulty-stat-label" data-i18n="stats.winRate">Rate</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="stats-section" id="achievementsSection" style="display: none;">
                <h2 class="section-title" data-i18n="stats.achievements">üèÖ Achievements</h2>
                <div class="achievements" id="achievementsList" role="region" aria-labelledby="achievements-title">
                    <h3 id="achievements-title" class="sr-only" data-i18n="stats.achievements">Achievements</h3>
                    <!-- Achievements will be populated by JavaScript -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn primary" onclick="exportStats()" data-i18n="stats.exportData">üì§ Export Data</button>
                <button class="action-btn secondary" onclick="closeStats()" data-i18n="stats.backToGame">‚Üê Back to Game</button>
            </div>

            <!-- Helper descriptions for accessibility -->
            <div class="helper-descriptions" aria-hidden="true">
                <span id="export-desc" class="sr-only">Export your game statistics as a JSON file</span>
                <span id="close-desc" class="sr-only">Return to the main game interface</span>
            </div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage" role="status" aria-live="polite"></div>
        </div>
    </div>

    <script>
        // User and stats data
        let currentUserId = null;
        let currentUserName = null;
        let statsData = null;

        // i18n support
        let currentLanguage = 'en';
        let translations = {};

        // Focus management
        let firstFocusableElement = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTranslations().then(() => {
                applyTranslations();
                detectHATheme();
                setupFocusManagement();
                identifyUser();
            });
        });

        // Load translations based on URL parameter or browser language
        async function loadTranslations() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') || detectBrowserLanguage();
            currentLanguage = lang;
            
            try {
                const response = await fetch(`languages/${lang}.json`);
                if (response.ok) {
                    translations = await response.json();
                    console.log(`‚úÖ Loaded ${lang} translations for stats`);
                } else {
                    // Fallback to English
                    console.warn(`‚ùå Could not load ${lang} translations, falling back to English`);
                    const response = await fetch(`languages/${lang}.json`);
                    if (response.ok) {
                        translations = await response.json();
                        currentLanguage = 'en';
                    }
                }
            } catch (error) {
                console.error('Error loading translations:', error);
                // Use empty object as fallback
                translations = {};
            }
        }

        // Detect browser language
        function detectBrowserLanguage() {
            const browserLang = navigator.language.substring(0, 2).toLowerCase();
            const supported = ['en', 'de', 'fr', 'es'];
            return supported.includes(browserLang) ? browserLang : 'en';
        }

        // Translation function
        function t(key, params = {}) {
            let translation = translations[key] || key;
            
            // Replace parameters {param} with values
            Object.keys(params).forEach(param => {
                translation = translation.replace(`{${param}}`, params[param]);
            });
            
            return translation;
        }

        // Apply translations to DOM elements
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = t(key);
                
                // Handle different element types
                if (element.tagName === 'INPUT') {
                    if (element.hasAttribute('placeholder')) {
                        element.placeholder = translation;
                    }
                    if (element.type === 'button' || element.type === 'submit') {
                        element.value = translation;
                    }
                } else {
                    element.textContent = translation;
                }
            });
            
            console.log(`‚úÖ Applied ${currentLanguage} translations to stats DOM`);
        }

        // Setup focus management
        function setupFocusManagement() {
            // Get first focusable element and focus it
            const focusableElements = document.querySelectorAll(
                'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length > 0) {
                firstFocusableElement = focusableElements[0];
                // Focus first element after stats load
                setTimeout(() => {
                    if (firstFocusableElement) {
                        firstFocusableElement.focus();
                    }
                }, 1500);
            }

            // Add keyboard navigation
            document.addEventListener('keydown', handleKeyDown);
        }

        // Handle keyboard navigation
        function handleKeyDown(e) {
            // Escape key to close stats
            if (e.key === 'Escape') {
                closeStats();
            }
        }

        // Auto-detect Home Assistant theme (same as audio config)
        function detectHATheme() {
            try {
                // Method 1: Check parent frame theme
                if (window.parent && window.parent !== window) {
                    const parentDoc = window.parent.document;
                    if (parentDoc) {
                        const haMain = parentDoc.querySelector('home-assistant');
                        if (haMain && haMain.hass && haMain.hass.themes) {
                            const currentTheme = haMain.hass.themes.darkMode ? 'dark' : 'light';
                            document.body.setAttribute('data-theme', currentTheme);
                            console.log(`üé® Applied HA theme: ${currentTheme}`);
                            return;
                        }
                    }
                }
                
                // Method 2: Check URL parameters for theme
                const urlParams = new URLSearchParams(window.location.search);
                const themeParam = urlParams.get('theme');
                if (themeParam) {
                    document.body.setAttribute('data-theme', themeParam);
                    console.log(`üé® Applied URL theme: ${themeParam}`);
                    return;
                }
                
                // Method 3: Use browser preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.setAttribute('data-theme', 'dark');
                    console.log('üé® Applied dark theme from browser preference');
                } else {
                    document.body.setAttribute('data-theme', 'light');
                    console.log('üé® Applied light theme from browser preference');
                }
                
            } catch (error) {
                console.warn('Theme detection failed, using default:', error);
                document.body.setAttribute('data-theme', 'light');
            }
        }

        // Identify user from URL parameters
        function identifyUser() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                currentUserId = urlParams.get('user_id');
                currentUserName = urlParams.get('user_name') || 'Unknown User';
                
                if (!currentUserId) {
                    throw new Error('No user ID provided');
                }
                
                console.log(`[Stats] User identified: ${currentUserName} (${currentUserId})`);
                
                // Update display with user name
                const userNameDisplay = document.getElementById('userNameDisplay');
                if (userNameDisplay) {
                    userNameDisplay.textContent = t('stats.playerStats', { name: currentUserName });
                }
                
                // Load stats for this user
                loadUserStats();
                
            } catch (error) {
                console.error('[Stats] Error identifying user:', error);
                showError(t('stats.loadError') || 'Failed to load statistics');
            }
        }

        // Load user statistics from Home Assistant
        async function loadUserStats() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const accessToken = urlParams.get('access_token');
                
                if (!accessToken) {
                    throw new Error('No access token provided');
                }
                
                // Fetch stats sensor
                const sensorEntityId = `sensor.ha_wordplay_stats_${currentUserId}`;
                const response = await fetch(`/api/states/${sensorEntityId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch stats sensor: ${response.status}`);
                }
                
                const sensorData = await response.json();
                console.log('[Stats] Sensor data:', sensorData);

                if (sensorData && sensorData.attributes) {
                    statsData = sensorData.attributes;
                    displayStats();
                } else {
                    throw new Error('No stats data found');
                }

            } catch (error) {
                console.error('[Stats] Error loading stats:', error);
                showError(t('stats.loadError') || 'Failed to load statistics');
            }
        }

        // Display all statistics
        function displayStats() {
            console.log('[Stats] Displaying stats:', statsData);
            
            // Hide loading, show content
            document.getElementById('loadingIndicator').style.display = 'none';
            
            // Display overview stats
            displayOverviewStats();
            
            // Display guess distribution
            displayGuessDistribution();
            
            // Display difficulty stats
            displayDifficultyStats();
            
            // Display achievements
            displayAchievements();
            
            // Show all sections
            document.getElementById('overviewSection').style.display = 'block';
            document.getElementById('distributionSection').style.display = 'block';
            document.getElementById('difficultySection').style.display = 'block';
            document.getElementById('achievementsSection').style.display = 'block';
            
            showStatus(t('stats.loadSuccess') || 'Statistics loaded successfully!', 'success');
        }

        // Display overview statistics
        function displayOverviewStats() {
            document.getElementById('totalGames').textContent = statsData.games_played || 0;
            document.getElementById('totalWins').textContent = statsData.games_won || 0;
            document.getElementById('winPercentage').textContent = statsData.win_rate_display || '0%';
            document.getElementById('currentStreak').textContent = statsData.current_streak || 0;
            document.getElementById('maxStreak').textContent = statsData.max_streak || 0;
            document.getElementById('averageGuesses').textContent = statsData.average_guesses || '0.0';
            document.getElementById('totalPlayTime').textContent = statsData.play_time_display || '0s';
            document.getElementById('fastestWin').textContent = statsData.fastest_win_display || 'N/A';
        }

        // Display guess distribution chart
        function displayGuessDistribution() {
            const chartContainer = document.getElementById('guessChart');
            const distribution = statsData.guess_distribution || {};
            const totalWins = statsData.games_won || 0;
            
            chartContainer.innerHTML = '';
            
            if (totalWins === 0) {
                const noWinsMsg = document.createElement('p');
                noWinsMsg.style.textAlign = 'center';
                noWinsMsg.style.color = 'var(--text-secondary-color)';
                noWinsMsg.textContent = t('stats.noWinsYet') || 'No wins yet - play some games to see your guess distribution!';
                chartContainer.appendChild(noWinsMsg);
                return;
            }

            // Create bars for guesses 1-8
            for (let guess = 1; guess <= 8; guess++) {
                const count = distribution[guess] || 0;
                const percentage = totalWins > 0 ? (count / totalWins * 100) : 0;
                
                const row = document.createElement('div');
                row.className = 'chart-row';
                row.setAttribute('role', 'presentation');
                
                const guessNum = document.createElement('div');
                guessNum.className = 'guess-number';
                guessNum.textContent = guess;
                guessNum.setAttribute('aria-label', `${guess} guesses`);
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.width = `${Math.max(percentage, 5)}%`; // Minimum 5% width for visibility
                bar.textContent = count > 0 ? count : '';
                bar.setAttribute('aria-label', t('stats.guessCount', { count: count, guess: guess }) || `${count} games won in ${guess} guesses`);
                
                const countDisplay = document.createElement('div');
                countDisplay.className = 'chart-count';
                countDisplay.textContent = count;
                countDisplay.setAttribute('aria-hidden', 'true');
                
                row.appendChild(guessNum);
                row.appendChild(bar);
                row.appendChild(countDisplay);
                
                chartContainer.appendChild(row);
            }
        }

        // Display difficulty statistics
        function displayDifficultyStats() {
            const difficultyData = statsData.difficulty_stats || {};
            
            // Easy mode stats
            const easyStats = difficultyData.easy || {};
            document.getElementById('easyWins').textContent = easyStats.games_won || 0;
            document.getElementById('easyRate').textContent = easyStats.win_rate_display || '0%';
            
            // Normal mode stats
            const normalStats = difficultyData.normal || {};
            document.getElementById('normalWins').textContent = normalStats.games_won || 0;
            document.getElementById('normalRate').textContent = normalStats.win_rate_display || '0%';
            
            // Hard mode stats
            const hardStats = difficultyData.hard || {};
            document.getElementById('hardWins').textContent = hardStats.games_won || 0;
            document.getElementById('hardRate').textContent = hardStats.win_rate_display || '0%';
        }

        // Display achievements
        function displayAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            const achievements = getAchievements();
            
            achievementsList.innerHTML = '';
            
            achievements.forEach(achievement => {
                const achievementEl = document.createElement('div');
                achievementEl.className = `achievement ${achievement.earned ? 'earned' : 'locked'}`;
                achievementEl.setAttribute('role', 'img');
                achievementEl.setAttribute('aria-label', `${achievement.name}: ${achievement.desc} - ${achievement.earned ? t('achievement.earned') || 'Earned' : t('achievement.locked') || 'Not earned yet'}`);
                
                achievementEl.innerHTML = `
                    <div class="achievement-icon" aria-hidden="true">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                
                achievementsList.appendChild(achievementEl);
            });
        }

        // Get achievements with localized names and descriptions
        function getAchievements() {
            const stats = statsData || {};
            return [
                {
                    icon: 'ü©∏',
                    name: t('achievement.firstBlood') || 'First Blood',
                    desc: t('achievement.firstBloodDesc') || 'Win your first game',
                    earned: (stats.games_won || 0) >= 1
                },
                {
                    icon: 'üé©',
                    name: t('achievement.hatTrick') || 'Hat Trick',
                    desc: t('achievement.hatTrickDesc') || 'Win 3 games in a row',
                    earned: (stats.max_streak || 0) >= 3
                },
                {
                    icon: 'üî•',
                    name: t('achievement.onFire') || 'On Fire',
                    desc: t('achievement.onFireDesc') || 'Win 5 games in a row',
                    earned: (stats.max_streak || 0) >= 5
                },
                {
                    icon: '‚ö°',
                    name: t('achievement.lightning') || 'Lightning Round',
                    desc: t('achievement.lightningDesc') || 'Win on first guess',
                    earned: (stats.guess_distribution && stats.guess_distribution[1] || 0) >= 1
                },
                {
                    icon: 'üîü',
                    name: t('achievement.perfect10') || 'Perfect 10',
                    desc: t('achievement.perfect10Desc') || 'Win 10 total games',
                    earned: (stats.games_won || 0) >= 10
                },
                {
                    icon: 'üíØ',
                    name: t('achievement.centuryClub') || 'Century Club',
                    desc: t('achievement.centuryClubDesc') || 'Play 100 games',
                    earned: (stats.games_played || 0) >= 100
                },
                {
                    icon: 'üéØ',
                    name: t('achievement.perfectionist') || 'Perfectionist',
                    desc: t('achievement.perfectionistDesc') || '90% win rate (min 10 games)',
                    earned: (stats.games_played || 0) >= 10 && (stats.win_rate || 0) >= 90
                },
                {
                    icon: 'üöÄ',
                    name: t('achievement.unstoppable') || 'Unstoppable',
                    desc: t('achievement.unstoppableDesc') || 'Win 10 games in a row',
                    earned: (stats.max_streak || 0) >= 10
                }
            ];
        }

        // Export statistics data
        function exportStats() {
            try {
                const exportData = {
                    user_id: currentUserId,
                    user_name: currentUserName,
                    export_date: new Date().toISOString(),
                    stats: statsData
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `wordplay_stats_${currentUserName}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus(t('stats.exportSuccess') || 'Statistics exported successfully!', 'success');
                
            } catch (error) {
                console.error('[Stats] Export error:', error);
                showStatus(t('stats.exportError') || 'Failed to export statistics', 'error');
            }
        }

        // Close stats window with proper focus management
        function closeStats() {
            // Close window or return to parent
            if (window.parent && window.parent !== window) {
                try {
                    window.parent.postMessage({action: 'closeStats'}, '*');
                } catch (error) {
                    console.warn('Could not send close message to parent:', error);
                }
            } else {
                window.close();
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            showStatus(message, 'error');
        }
    </script>
</body>
</html>